<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='icon' type='image/png' sizes='96x96' href='favicon-96x96.png'>
    <link rel='stylesheet' href='css/common.css'>
    <title>Simple WebXR AR Test</title>
  </head>
  <body>
    <header>
      <details open>
        <summary>Simple WebXR AR Test</summary>
        <p>
          This is a simplified version of the hit-test-anchors demo with fewer required features.
          <br/>
          This page tests if your device supports basic WebXR AR functionality.
        </p>
      </details>
    </header>
    <script type="module">
      import {WebXRButton} from './js/util/webxr-button.js';
      import {Scene} from './js/render/scenes/scene.js';
      import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
      import {Gltf2Node} from './js/render/nodes/gltf2.js';
      import {vec3} from './js/render/math/gl-matrix.js';

      // XR globals.
      let xrButton = null;
      let xrSession = null;
      let xrRefSpace = null;
      let hitTestSource = null;

      // WebGL scene globals.
      let gl = null;
      let renderer = null;
      let scene = new Scene();
      scene.enableStats(false);

      // Array to store all placed flowers
      let flowers = [];
      
      // Flower size - increased from 0.1 to 0.3 (3x bigger)
      const FLOWER_SCALE = 0.3;

      function initXR() {
        xrButton = new WebXRButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession,
          textEnterXR: "START AR",
          textXRNotFound: "AR NOT SUPPORTED",
          textExitXR: "EXIT AR"
        });
        document.querySelector('header').appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar')
              .then((supported) => {
            xrButton.enabled = supported;
          });
        }
      }

      function onRequestSession() {
        // Using local and hit-test features to allow placing multiple flowers
        return navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['local', 'hit-test']
        }).then((session) => {
          xrSession = session;
          xrButton.setSession(session);
          onSessionStarted(session);
        });
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);
        session.addEventListener('select', onSelect); // Add select event for tapping

        if (!gl) {
          gl = createWebGLContext({
            xrCompatible: true
          });

          renderer = new Renderer(gl);
          scene.setRenderer(renderer);
        }

        session.updateRenderState({
          baseLayer: new XRWebGLLayer(session, gl)
        });

        // Request both reference spaces
        Promise.all([
          session.requestReferenceSpace('local'),
          session.requestReferenceSpace('viewer')
        ]).then((spaces) => {
          xrRefSpace = spaces[0];
          
          // Set up hit testing
          const viewerSpace = spaces[1];
          session.requestHitTestSource({ space: viewerSpace }).then((source) => {
            hitTestSource = source;
          });
          
          session.requestAnimationFrame(onXRFrame);
        });
      }

      function onEndSession(session) {
        session.end();
      }

      function onSessionEnded(event) {
        xrSession = null;
        xrButton.setSession(null);
        hitTestSource = null;
      }
      
      // Function to handle the select event (when user taps the screen)
      function onSelect(event) {
        if (hitTestSource) {
          const frame = event.frame;
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          
          // If we hit something, place a flower there
          if (hitTestResults.length > 0) {
            const hit = hitTestResults[0];
            const pose = hit.getPose(xrRefSpace);
            
            // Create a new sunflower at the hit location
            const sunflower = new Gltf2Node({url: 'media/gltf/sunflower/sunflower.gltf'});
            sunflower.scale = [FLOWER_SCALE, FLOWER_SCALE, FLOWER_SCALE]; // Make flowers bigger
            sunflower.translation = pose.transform.position;
            sunflower.rotation = pose.transform.orientation;
            
            // Add the flower to the scene and our array
            scene.addNode(sunflower);
            flowers.push(sunflower);
          }
        }
      }

      function onXRFrame(time, frame) {
        let session = frame.session;
        let pose = frame.getViewerPose(xrRefSpace);

        scene.startFrame();
        
        // Draw the scene
        if (pose) {
          session.requestAnimationFrame(onXRFrame);
          scene.drawXRFrame(frame, pose);
        }
        
        scene.endFrame();
      }

      initXR();
    </script>
  </body>
</html>
